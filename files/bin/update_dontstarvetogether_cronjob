#!/bin/bash


main() {
  if servers_are_paused; then
    stop_services
    update
    start_services
  fi
}


update() {
  sudo -u steam sh -c '/home/steam/cmd/steamcmd.sh +runscript /home/steam/apps/dontstarvetogether/bin/update > /var/log/update_dontstarvetogether.log 2>&1'
  sudo -u steam sh -c "echo $? > /var/log/update_dontstarvetogether.ret"
  /home/steam/cmd/steamcmd.sh +runscript /home/steam/apps/dontstarvetogether/bin/update 
}


stop_services() {
  for service in /etc/init.d/dst-*; do
    $service stop || fail "Failed to stop service:  ${service}"
  done
}


start_services() {
  failed_services=()
  for service in /etc/init.d/dst-*; do
    if ! $service start; then
      warn "Failed to start service: ${service}"
      failed_services+=("${service}")
    fi
    if ! test 0 = "${#failed_services[@]}"; then
      fail "Failed to start services:  ${failed_services[@]}"
    fi
  done
}


fail() {
  echo -- "ERROR:  ${@}" >&2
  exit 1
}


warn() {
  echo -- "WARNING:  ${@}" >&2
}


server_is_paused() {
  log=$1

  last_pause_line="$(
    grep pause $log \
    | tail -n 1
  )"
  case "${last_pause_line}" in
    'Sim paused')
      # The server is up, but no one is playing.
      return 0
      ;;
    '')
      # The server is not up.
      return 0
      ;;
    'Sim unpaused')
      # The server is up and people are playing.
      return 1
      ;;
    *)
      # Unknown state.
      return 2
      ;;
  esac
}


servers_are_paused() {
  for log in /var/log/dst-*; do
    if ! server_is_paused $log; then
      warn "Server not paused -- log file:  $log"
      return 1
    fi
  done
}


main
